# =========================
#   BTT SKR 1.4 — Klipper
#   Ender Extender 300×300×200 (bedslinger)
#   Stealthburner (CW2) + Revo/ObXidian 0.4, BLTouch, Dual Z + Z_TILT
# =========================

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[exclude_object]

[mcu]
# Replace with your SKR 1.4 serial (ls /dev/serial/by-id/*)
serial: /dev/serial/by-id/usb-Klipper_lpc1768_0D80000BA498C89519CC3461C32000F5-if00

[temperature_sensor RaspberryPi4_2GB]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

####################
# INCLUDE SECTION  #
####################
[include KAMP_Settings.cfg]

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 15        # Landon: 5
max_z_accel: 150          # Landon: 100
square_corner_velocity: 6

# -------------------------
#   STEPPERS (TMC2209 UART)
#   Driver sockets: 0=X, 1=Y, 2=Z, 3=E0, 4=E1
# -------------------------

[stepper_x]
step_pin: P2.2
dir_pin: !P2.6
enable_pin: !P2.1
microsteps: 16
rotation_distance: 40
endstop_pin: ^P1.29
position_endstop: -21
position_min: -21
position_max: 300
homing_speed: 200

[tmc2209 stepper_x]
uart_pin: P1.10
run_current: 0.580
stealthchop_threshold: 0

[stepper_y]
step_pin: P0.19
dir_pin: !P0.20
enable_pin: !P2.8
microsteps: 16
rotation_distance: 40
endstop_pin: ^P1.28
position_endstop: -14
position_min: -14
position_max: 291
homing_speed: 200

[tmc2209 stepper_y]
uart_pin: P1.9
run_current: 0.700
stealthchop_threshold: 0

[stepper_z]
step_pin: P0.22
dir_pin: P2.11
enable_pin: !P0.21
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -2
position_max: 250

[tmc2209 stepper_z]
uart_pin: P1.8
run_current: 0.50
stealthchop_threshold: 0

# Right Z motor on E1 driver
[stepper_z1]
step_pin: P1.15
dir_pin: P1.14
enable_pin: !P1.16
microsteps: 16
rotation_distance: 8

[tmc2209 stepper_z1]
uart_pin: P1.1
run_current: 0.50
stealthchop_threshold: 0

# -------------------------
#   EXTRUDER (CW2 direct-drive)
# -------------------------
[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: P2.7                 # HE0
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: P0.24                # TH0
#control: pid
#pid_Kp: 34.909
#pid_Ki: 3.373
#pid_Kd: 90.327
min_temp: 0
max_temp: 270
max_power: 1.0
pressure_advance: 0.096          # tune per filament
pressure_advance_smooth_time: 0.040
max_extrude_cross_section: 10

[tmc2209 extruder]
uart_pin: P1.4
interpolate: false
sense_resistor: 0.110           # Landon
run_current: 0.85               # Landon
stealthchop_threshold: 0

# -------------------------
#   HEATED BED
# -------------------------
[heater_bed]
heater_pin: P2.5                 # BED MOSFET
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.25                # THB
#control: pid
#pid_Kp: 52.355
#pid_Ki: 1.745
#pid_Kd: 392.662
min_temp: 0
max_temp: 130

# -------------------------
#   BLTOUCH (PROBE header + SERVO0)
# -------------------------
[bltouch]
sensor_pin: ^P0.10               # PROBE
control_pin: P2.0                # SERVO0
x_offset: -40
y_offset: -12
#z_offset: 5.0                    # re-calibrate
speed: 50                         # Landon
samples: 1                        # Landon
sample_retract_dist: 5.0          # Landon
stow_on_each_sample: False
probe_with_touch_mode: True
lift_speed: 80                    # Landon
samples_tolerance_retries: 3
samples_result: median
samples_tolerance: 0.01

[safe_z_home]
home_xy_position: 159,166
speed: 200
z_hop: 7
z_hop_speed: 20

[bed_mesh]
speed: 200
horizontal_move_z: 7
mesh_min: -20, -10
mesh_max: 210, 250
probe_count: 5,5
algorithm: bicubic
fade_start: 1
fade_end: 10

# -------------------------
#   FANS
# -------------------------

# Hotend fan as thermostatic — HE1 low-side
# Wire fan + to 24V, fan – to HE1 –
[heater_fan hotend_fan]
pin: P2.4
heater: extruder
heater_temp: 45.0

# Part cooling — FAN0
[fan]
pin: P2.3

# -------------------------
#   FILAMENT SENSOR
# -------------------------
[filament_motion_sensor filament_sensor]
switch_pin: ^P1.26               # E0DET
extruder: extruder
detection_length: 25
pause_on_runout: True
insert_gcode:
  M117 Filament detected
runout_gcode:
  M117 Runout/Jam detected
  LED_ERROR
  PAUSE

# -------------------------
#   INPUT SHAPER
# -------------------------
[input_shaper]
shaper_type_x: ei
shaper_freq_x: 32.8
# shaper_type_y: <after_measurement>
# shaper_freq_y: <after_measurement>

# -------------------------
#   Z TILT (dual Z leadscrews)
# -------------------------
[z_tilt]
z_positions:
  0,150
  300,150

points:
  0,150
  230,150
speed: 500
horizontal_move_z: 7
retries: 5
retry_tolerance: 0.02

# -------------------------
#   NEOPIXELS
# -------------------------
[LED stealthburner]
pin: P1.24
chain_count: 3                 # set to your toolhead LED count
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

[LED frame]
pin: P1.25
chain_count: 30                # set to your strip length
color_order: GRB               # or GRBW if applicable
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

# -------------------------
#   LED STATE HELPERS
# -------------------------
[gcode_macro LED_HEATING]
gcode:
  SET_LED LED="stealthburner" RED=1.0 GREEN=0.5 BLUE=0.0
  SET_LED LED="frame"         RED=1.0 GREEN=0.5 BLUE=0.0

[gcode_macro LED_PRINTING]
gcode:
  SET_LED LED="stealthburner" RED=1.0 GREEN=1.0 BLUE=1.0
  SET_LED LED="frame"         RED=1.0 GREEN=1.0 BLUE=1.0

[gcode_macro LED_COMPLETE]
gcode:
  SET_LED LED="stealthburner" RED=0.0 GREEN=1.0 BLUE=0.0
  SET_LED LED="frame"         RED=0.0 GREEN=1.0 BLUE=0.0

[gcode_macro LED_ERROR]
gcode:
  SET_LED LED="stealthburner" RED=1.0 GREEN=0.0 BLUE=0.0
  SET_LED LED="frame"         RED=1.0 GREEN=0.0 BLUE=0.0

# -------------------------
#   MACROS (merged)
# -------------------------

[pause_resume]
[display_status]

# Marlin-style alias
[gcode_macro G29]
description: Calibrate bed mesh and park at front-right
gcode:
    BED_MESH_CALIBRATE
    G1 X250 Y0 Z2 F4000

[gcode_macro _PARK_VARS]
variable_park_x: 10
variable_park_y: 10
variable_park_z_lift: 10
gcode:

[gcode_macro START_PRINT]
description: Preheat, home, Z-tilt, KAMP adaptive mesh + line purge, then print
# Usage from slicer: START_PRINT BED=60 EXTRUDER=210
variable_bed: 60
variable_extruder: 210
gcode:
  {% set bed = params.BED|default(60)|float %}
  {% set ext = params.EXTRUDER|default(210)|float %}
  {% set probe_preheat = 160.0 %}

  LED_HEATING

  M140 S{bed}
  M104 S{probe_preheat}
  M190 S{bed}
  M109 S{probe_preheat}

  G90
  M83
  G28

  # BLTouch sanity + clearance
  BLTOUCH_DEBUG COMMAND=reset
  G4 P300
  BLTOUCH_DEBUG COMMAND=pin_up
  G1 Z10 F1200

  # Straighten gantry before meshing
  Z_TILT_SAFE
  G1 Z10 F1200

  BED_MESH_CLEAR
  # KAMP adaptive mesh over object area (clamped to your [bed_mesh] limits)
  BED_MESH_CALIBRATE AREA_START={PRINT_MIN} AREA_END={PRINT_MAX}
  G1 Z10 F1200

  # Final nozzle temp
  M104 S{ext}
  M109 S{ext}
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1

  LED_PRINTING

  # KAMP adaptive line purge
  LINE_PURGE

  G92 E0

[gcode_macro PAUSE]
description: Pause the actual running print (variable retract + safe park)
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% set x_park = (printer.toolhead.axis_maximum.x|float) - 5.0 %}
  {% set y_park = (printer.toolhead.axis_maximum.y|float) - 5.0 %}
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = (max_z - act_z) %}
  {% endif %}

  SAVE_GCODE_STATE NAME=PAUSE_state
  PAUSE_BASE

  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough for retract")}
  {% endif %}

  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z{z_safe} F1200
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed; skipping XY park")}
  {% endif %}

  M106 S0

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY) %}
  {% else %}
    {% set get_params = "" %}
  {% endif %}

  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough to unretract")}
  {% endif %}

  RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
  RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  M106 S0
  LED_ERROR
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  CANCEL_PRINT_BASE

[gcode_macro END_PRINT]
description: Park and cool down
gcode:
  G92 E0
  G1 E-2 F1800
  G91
  G1 Z10 F6000
  G90
  G1 X5 Y295 F12000
  M107
  TURN_OFF_HEATERS
  M84
  LED_COMPLETE

[gcode_macro Z_TILT_SAFE]
gcode:
  BLTOUCH_DEBUG COMMAND=reset
  G4 P300
  BLTOUCH_DEBUG COMMAND=pin_up
  G4 P200
  G28
  Z_TILT_ADJUST

# --- Optional: firmware retraction (used by KAMP if present) ---
[firmware_retraction]
retract_length: 1.0
retract_speed: 25
unretract_extra_length: 0
unretract_speed: 25

# --- Optional: quick first-layer Z nudges ---
[gcode_macro Z_UP]
description: Nudge nozzle away from bed by +0.02mm
gcode:
  SET_GCODE_OFFSET Z_ADJUST=+0.02 MOVE=1

[gcode_macro Z_DOWN]
description: Nudge nozzle toward bed by -0.02mm
gcode:
  SET_GCODE_OFFSET Z_ADJUST=-0.02 MOVE=1

# --- Idle timeout (heaters/motors off after 10 min) ---
[idle_timeout]
timeout: 600
gcode:
  TURN_OFF_HEATERS
  M84

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.909
#*# pid_ki = 3.373
#*# pid_kd = 90.327
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 52.355
#*# pid_ki = 1.745
#*# pid_kd = 392.662
#*#
#*# [bltouch]
#*# z_offset = 2.630
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.181415, 0.123915, 0.076415, -0.006085
#*# 	  0.091415, 0.051415, 0.048915, 0.001415
#*# 	  -0.003585, -0.016085, -0.021085, -0.038585
#*# 	  -0.088585, -0.086085, -0.086085, -0.088585
#*# x_count = 4
#*# y_count = 4
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 73.1582
#*# max_x = 209.98819999999998
#*# min_y = 73.1582
#*# max_y = 226.8182
